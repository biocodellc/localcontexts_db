{% load custom_project_tags %}

{% if 'projects/actions/' in request.path %}
    {% if request.user.is_authenticated %}
        <div class="back-to-projects">
            <a 
                class="pointer margin-top-2 margin-left-8"
                {% if community %}
                    href="{% url 'community-projects' community.id %}"
                {% endif %}
                {% if institution %}
                    href="{% url 'institution-projects' institution.id %}"
                {% endif %}
                {% if researcher %}
                    href="{% url 'researcher-projects' researcher.id %}"
                {% endif %}
            >
                <i class="fa fa-arrow-left darkteal-text margin-right-8"></i><span class="primary-black-text">Back to Projects</span>
            </a>
        </div>
    {% endif %}
{% endif %}

<div class="flex-this auto-margin" style="max-width: 1271px;">

    <!-- PROJECT -->
    <div class="project-card content-card-space">
        <h1>{{ project.title }}</h1>
        <div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Date created</p></div>
                <div><p>{{ project.date_added|date:'d M Y' }}</p></div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Project type</p></div>
                <div><p>{{ project.project_type }}</p></div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Project visibility</p></div>
                <div><p>{{ project.project_privacy }}</p></div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Creator</p></div>
                <div>
                    <p>
                        {% firstof project.project_creator.get_full_name project.project_creator.username %} | 
                        {% firstof creator.community creator.institution %}
                        {% if creator.researcher %} Researcher {% endif %}
                    </p>
                </div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Status</p></div>
                <div><p>{% if project_archived %} Archived {% else %} Active {% endif %}</p></div>
            </div>
            {% if project.source_project_uuid %}
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Source Project</p></div>
                    <div><p>
                            <em>
                                <a 
                                    class="darkteal-text underline-hover" 
                                    {% if community %}
                                        href="{% url 'community-project-actions' community.id project.source_project_uuid %}"
                                    {% endif %}
                                    {% if institution %}
                                        href="{% url 'institution-project-actions' institution.id project.source_project_uuid %}"
                                    {% endif %}
                                    {% if researcher %}
                                        href="{% url 'researcher-project-actions' researcher.id project.source_project_uuid %}"
                                    {% endif %}
                                    {% if not community and not institution and not researcher %}
                                        href="{% url 'view-project' project.source_project_uuid  %}"
                                    {% endif %}
                                    
                                >
                                {% source_project_title project.source_project_uuid as title %}
                                {{ title }}
                            </a></em>
                    </p></div>
                </div>
            {% endif %}
        </div>

        <div>
            <div class="project-header-div border-top-solid-teal border-bottom-solid-teal flex-this space-between">
                <h2>Project details</h2>
                <h2 class="margin-right-8 pointer" onclick="toggleProjectInfo(this, 'projectDetailsDiv')"><i class="fa-solid fa-minus fa-xl darkteal-text"></i></h2>
            </div>
            <div id="projectDetailsDiv" style="height: auto; overflow: hidden;">
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Description</p></div>
                    <div><p>{{ project.description|linebreaks }}</p></div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Contact</p></div>
                    <div><p>{{ project.project_contact }}<br>{{ project.project_contact_email }}</p></div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Links</p></div>
                    <div> 
                        {% if project.urls %}
                            <ul>
                                {% for url in project.urls %}
                                    <li>
                                        <a href="{{ url }}" class="darkteal-text underline-hover word-break" target="_blank" rel="noopener">{{ url }} <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No links added</p>
                        {% endif %}
                    </div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Contributors</p></div>
                    <div class="w-60">                    
                        <ul>
                            {% if project.project_contributors.communities %}
                                {% for account in project.project_contributors.communities.all %}
                                    <li>
                                        <div class="flex-this space-between">
                                            <div>
                                                <a href="{% url 'public-community' account.id %}" class="darkteal-text underline-hover">{{ account.community_name }}</a> | Community 
                                            </div>
                                            {% if account == community and not account == creator.community %} 
                                                <div>
                                                    <a onclick="openRemoveContributorModal()" class="pointer darkteal-text underline-hover margin-left-16"><i class="fa-solid fa-xmark fa-lg"></i></a> 
                                                </div>
                                            {% endif %}                                            
                                        </div>
                                    </li>
                                {% endfor %}
                            {% endif %}

                            {% if project.project_contributors.institutions %}
                                {% for account in project.project_contributors.institutions.all %}
                                    <li>
                                        <div class="flex-this space-between">
                                            <div>
                                                <a href="{% url 'public-institution' account.id %}" class="darkteal-text underline-hover">{{ account.institution_name }}</a> | Institution 
                                            </div>
                                            {% if account == institution and not account == creator.institution %} 
                                                <div>
                                                    <a onclick="openRemoveContributorModal()" class="pointer darkteal-text underline-hover margin-left-16"><i class="fa-solid fa-xmark fa-lg"></i></a> 
                                                </div>
                                            {% endif %}                                            
                                        </div>
                                    </li>
                                {% endfor %}
                            {% endif %}

                            {% if project.project_contributors.researchers %}
                                {% for account in project.project_contributors.researchers.all %}
                                    <li>
                                        <div class="flex-this space-between">
                                            <div>
                                                {% if account.orcid %}
                                                    <a class="darkteal-text" itemprop="sameAs" content="{{ account.orcid }}" href="{{ account.orcid }}" target="orcid.widget" rel="me noopener noreferrer" style="vertical-align:top;">
                                                        <img loading="lazy" src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="margin-top:2.5px;" alt="ORCID iD icon">
                                                    </a>
                                                {% endif %}
                                                <a href="{% url 'public-researcher' account.id %}" class="darkteal-text underline-hover">{% firstof account.user.get_full_name account.user.username %}</a> | Researcher
                                            </div>
                                            {% if account == researcher and not account == creator.researcher %} 
                                                <div>
                                                    <a onclick="openRemoveContributorModal()" class="pointer darkteal-text underline-hover margin-left-16"><i class="fa-solid fa-xmark fa-lg"></i></a> 
                                                </div>
                                            {% endif %}                                            
                                        </div>
                                    </li>
                                {% endfor %}
                            {% endif %}
                            {% if project.additional_contributors %}
                                {% for contributor in project.additional_contributors.all %}
                                    <li>{{ contributor.name }} | Contributor </li>
                                {% endfor %}
                            {% endif %}
                        </ul>

                        {% if community or institution or researcher %}
                            <div id="removeContribModal" class="modal hide">
                                <div class="modal-defaults deactivate-modal flex-this column w-100">
                                    <div class="w-100">
                            
                                        <div>
                                            <h2 class="primary-black-text no-top-margin">Are you sure?</h2>  
                                            <p>Are you sure you want to remove your account as a contributor on this Project?</p>  
                                        </div>
                                        <form method="POST" action="">
                                            {% csrf_token %}
                                            <div class="flex-this w-100 text-align-center">
                                                <button class="primary-btn white-btn margin-right-1" name="remove_contributor">Yes, remove</button>    
                                                <button id="closeContributorModalBtn" class="margin-left-1 primary-btn action-btn">Cancel</button>
                                            </div>                                            
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Identifiers</p></div>
                    <div>
                        <div class="flex-this">
                            <div>
                                <p class="copyProjectIDBtn">
                                    <i class="round-btn fa-regular fa-clone fa-rotate-90"></i>
                                </p>
                            </div>  
                            <div class="margin-left-16">
                                <p>
                                    <span class="bold">Local Contexts Project ID</span><br>
                                    <span id="projectIDToCopy">{{ project.unique_id }}</span>
                                </p>
                            </div>                          
                        </div>

                        <div class="flex-this">
                            <div>
                                <p class="copyProjectURLBtn">
                                    <i class="round-btn fa-regular fa-clone fa-rotate-90"></i>
                                </p>
                            </div>  
                            <div class="margin-left-16">
                                <p>
                                    <span class="bold">Project URL</span><br>
                                    <span id="projectURLToCopy">{{ project.project_page }}</span>
                                </p>
                            </div>                          
                        </div>
                        

                        <p class="no-top-margin">
                            <span class="bold">Providers ID</span><br>
                            {{ project.providers_id }}<br><br>

                            <span class="bold">Publication DOI</span><br>
                            {{ project.publication_doi }}<br><br>

                            <span class="bold">Project Data GUID</span><br>
                            {{ project.project_data_guid }}<br><br>
                        </p>
                    </div>
                </div>
            </div>

            {% if notices %}
                <div class="project-header-div border-top-solid-teal border-bottom-solid-teal flex-this space-between">
                    <h2>Project Notices</h2>
                    <h2 class="margin-right-8 pointer" onclick="toggleProjectInfo(this, 'projectNoticesDiv')"><i class="fa-solid fa-minus fa-xl darkteal-text"></i></h2>
                </div>
                <div id="projectNoticesDiv" style="height: auto; overflow: hidden;">
                    {% for notice in notices %}
                        <div class="flex-this">
                            <div class="project-left-sidebar">
                                <p class="bold">
                                    {% if notice.notice_type == 'biocultural' %} Biocultural {% endif %}
                                    {% if notice.notice_type == 'traditional_knowledge' %} Traditional Knowledge {% endif %}
                                    {% if notice.notice_type == 'attribution_incomplete' %} Attribution Incomplete {% endif %}
                                </p>
                            </div>
                            <div>
                                <div class="margin-top-16">
                                    <img loading="lazy" src="{{ notice.img_url }}" width="78" height="78" alt="black square with white letters TK in the middle">
                                </div>
                                <p>
                                    {{ notice.default_text }} <br><br>
                                    {% for translation in notice.notice_translations.all %}
                                        <div class="flex-this space-between">
                                            <h3>{{ translation.translated_name }}</h3>
                                            <h3>{{ translation.language }}</h3>
                                        </div>
                                        {{ translation.translated_text }}<br><br>
                                    {% endfor %}
                                </p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if project.has_bclabels or project.has_tklabels %}
                <div class="project-header-div border-top-solid-teal border-bottom-solid-teal flex-this space-between">
                    <h2>Project Labels</h2>
                    <h2 class="margin-right-8 pointer" onclick="toggleProjectInfo(this, 'projectLabelsDiv')"><i class="fa-solid fa-minus fa-xl darkteal-text"></i></h2>
                </div>
                <div id="projectLabelsDiv" style="height: auto; overflow: hidden;">

                    {% for community, labels in label_groups.items %}
                        <div class="label-group">
                            <div class="flex-this space-between">
                                <div>
                                    <a class="darkteal-text underline-hover bold" href="{% url 'public-community' community.id %}">{{ community.community_name }}</a> <br>
                                    <p class="italic">
                                        <i class="fa-solid fa-tag"></i> {{ labels.bc_label_count|add:labels.tk_label_count }} Labels applied
                                    </p>                                
                                </div>
                                <div>
                                    <i id="{{community.id}}" onclick="showProjectLabels(this)" class="fa-solid fa-angle-down pointer" aria-label="Show Project Labels"></i>
                                </div>
                            </div>
                            <div id="showContent-{{community.id}}" class="hide">
                                {% for bclabel in labels.bc_labels %}
                                    <div class="flex-this border-bottom-not-last">
                                        <div>
                                            <div class="flex-this margin-top-16">
                                                <div>
                                                    {% include 'bclabels/which-label.html' %} 
                                                </div>
                                                <div class="margin-left-16">
                                                    <p class="no-top-margin bold">{{bclabel.name}} </p><br>
                                                </div>
                                            </div>
            
                                            <h3>{{ bclabel.language }}</h3>
                                            <p>
                                                {{ bclabel.label_text }} <br>
                                            </p>
                                            {% for translation in bclabel.bclabel_translation.all %}
                                                <h3>{{ translation.language }}</h3>
                                                <p>
                                                    {{ translation.translated_text }}
                                                </p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                                {% for tklabel in labels.tk_labels %}
                                    <div class="flex-this border-bottom-not-last">
                                        <div>
                                            <div class="flex-this margin-top-16">
                                                <div>
                                                    {% include 'tklabels/which-label.html' %} 
                                                </div>
                                                <div class="margin-left-16">
                                                    <p class="no-top-margin bold">{{ tklabel.name }} </p><br>
                                                </div>
                                            </div>
            
                                            <h3>{{ tklabel.language }}</h3>
                                            <p>
                                                {{ tklabel.label_text }} <br>
                                            </p>
                                            {% for translation in tklabel.tklabel_translation.all %}
                                                <h3>{{ translation.language }}</h3>
                                                <p>
                                                    {{ translation.translated_text }}
                                                </p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}                                
                            </div>

                        </div>
                    {% endfor %}

                </div>
            {% endif %}

            {% if not project.source_project_uuid %}
                <div class="project-header-div border-top-solid-teal border-bottom-solid-teal flex-this space-between">
                    <h2>Sub Projects</h2>
                    <h2 class="margin-right-8 pointer" onclick="toggleProjectInfo(this, 'subProjectsDiv')"><i class="fa-solid fa-minus fa-xl darkteal-text"></i></h2>
                </div>
                <div id="subProjectsDiv" style="height: auto; overflow: hidden;">

                    <div><p><strong>{{sub_projects.count}}</strong> Sub Projects </p></div>

                    <div class="margin-bottom-16">
                        {% if sub_projects %}
                            {% for field in sub_projects %}
                                <div class="related-projects-div flex-this space-between">
                                    <div class="w-80 margin-left-8">
                                        <a 
                                            class="darkteal-text underline-hover" 
                                            {% if community %}
                                                href="{% url 'community-project-actions' community.id field.0 %}"
                                            {% endif %}
                                            {% if institution %}
                                                href="{% url 'institution-project-actions' institution.id field.0 %}"
                                            {% endif %}
                                            {% if researcher %}
                                                href="{% url 'researcher-project-actions' researcher.id field.0 %}"
                                            {% endif %}
                                            {% if not community and not institution and not researcher %}
                                                href="{% url 'view-project' field.0 %}"
                                            {% endif %}
                                        >{{ field.1 }}</a>                                   
                                    </div>
                                </div>
                            {% endfor %}                     
                        {% endif %}
                    </div>
                </div>
            {% endif %}


            <div class="project-header-div border-top-solid-teal border-bottom-solid-teal flex-this space-between">
                <h2>Related Projects</h2>
                <h2 class="margin-right-8 pointer" onclick="toggleProjectInfo(this, 'relatedProjectsDiv')"><i class="fa-solid fa-minus fa-xl darkteal-text"></i></h2>
            </div>
            <div id="relatedProjectsDiv" style="height: auto; overflow: hidden;">

                <div class="flex-this space-between center-text margin-top-16">
                    <div>
                        <p>
                            <strong>{{project.related_projects.count}}</strong> Related Projects connected
                        </p>
                    </div>
                    {% if community or institution or researcher %}
                        {% if member_role == 'admin' or member_role == 'editor' or request.user == project.project_creator or researcher %}
                            <div class="flex-this">
                                <div class="margin-right-8">
                                    <a 
                                        class="primary-btn white-btn" 
                                        {% if community %}
                                            href="{% url 'create-project' community.id project.unique_id 'related' %}"
                                        {% endif %}
                                        {% if institution %}
                                            href="{% url 'inst-create-project' institution.id project.unique_id 'related' %}"
                                        {% endif %}
                                        {% if researcher %}
                                            href="{% url 'researcher-create-project' researcher.id project.unique_id 'related' %}"
                                        {% endif %}
                                    > Create Related Project <i class="margin-left-8 fa-solid fa-square-plus"></i></a>                            
                                </div>

                                <div>
                                    <a class="primary-btn green-btn" onclick="openModal('linkProjectsModal', 'closeLinkProjectsModal')">Connect Projects <i class="margin-left-8 fa-solid fa-link-simple"></i></a>
                                </div>
                            </div>    
                        {% endif %}
                    {% endif %}
                </div>

                <div class="margin-bottom-16">
                    {% if project.related_projects.all %}
                        {% for p in project.related_projects.all %}
                            <div class="related-projects-div flex-this space-between">
                                <div class="w-80 margin-left-8">
                                    <a 
                                        class="darkteal-text underline-hover" 
                                        {% if community %}
                                            href="{% url 'community-project-actions' community.id p.unique_id %}"
                                        {% endif %}
                                        {% if institution %}
                                            href="{% url 'institution-project-actions' institution.id p.unique_id %}"
                                        {% endif %}
                                        {% if researcher %}
                                            href="{% url 'researcher-project-actions' researcher.id p.unique_id %}"
                                        {% endif %}
                                        {% if not community and not institution and not researcher %}
                                            href="{% url 'view-project' p.unique_id %}"
                                        {% endif %}
                                    >{{ p.title }}</a>                                     
                                </div>
                                {% if community or institution or researcher %}
                                    {% if member_role == 'admin' or member_role == 'editor' or researcher %}
                                        <div class="margin-right-8">
                                            <a 
                                                class="primary-black-text unlink-related-project-btn pointer"
                                                onclick="openUnlinkProjectModal(`{{p.unique_id}}`)"
                                            >
                                                <i 
                                                    class="fa-solid fa-link-simple-slash" 
                                                    aria-label="Remove Project connection to related Project"
                                                ></i>
                                            </a>
                                        </div>

                                        <div id="unlinkProjectModal-{{p.unique_id}}" class="modal hide" data-modal="unlinkProjectModal" data-id="{{p.unique_id}}">
                                            <div class="modal-defaults project-unlink-modal flex-this column w-100">
                                                <div class="w-100">

                                                    <div class="flex-this space-between margin-bottom-16">
                                                        <div class="w-80">
                                                            <h2 class="primary-black-text no-top-margin">Remove Project Connection</h2>  
                                                            <p>Are you sure you want to remove this connection?</p>  
                                                        </div>
                                                        <div>
                                                            <div id="close-modal-btn-{{p.unique_id}}" class="pointer" data-action="close"><i class="fa-regular fa-xmark fa-xl"></i></div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="flex-this">
                                                        <div class="w-50 margin-right-8">
                                                            <a 
                                                                class="primary-btn action-btn center-text"
                                                                {% if community %}
                                                                    href="{% url 'community-unlink-project' community.id project.unique_id p.unique_id %}"
                                                                {% endif %}
                                                                {% if institution %}
                                                                    href="{% url 'institution-unlink-project' institution.id project.unique_id p.unique_id %}"
                                                                {% endif %}
                                                                {% if researcher %}
                                                                    href="{% url 'researcher-unlink-project' researcher.id project.unique_id p.unique_id %}"
                                                                {% endif %}
                                                            >
                                                                Yes, remove this Project connection
                                                            </a>
                                                        </div>

                                                        <div class="w-50">
                                                            <a 
                                                                id="cancelBtn-{{p.unique_id}}"
                                                                class="primary-btn white-btn center-text"
                                                                data-action="cancel"
                                                            >
                                                                No, keep this Project connected
                                                            </a>
                                                        </div>                                                        
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endfor %}                     
                    {% endif %}
                </div>
            </div>

            {% include 'projects/project-comment.html'%}

            {% if activities %}
                <div class="project-header-div border-top-solid-teal border-bottom-solid-teal flex-this space-between">
                    <h2>
                        Project activity
                        <div class="tooltip" style="margin-left: 5px;"><strong>i</strong>
                            <span class="tooltiptext">
                                Project activity is only visible to Project contributors.
                            </span>
                        </div> 
                    </h2>
                    <h2 class="margin-right-8 pointer" onclick="toggleProjectInfo(this, 'projectActivityDiv')"><i class="fa-solid fa-plus fa-xl darkteal-text"></i></h2>
                </div>
                <div id="projectActivityDiv" style="height: 0px; overflow: hidden;">
                    {% for activity in activities %}
                        <ul>
                            <li>
                                <div class="flex-this space-between w-100">
                                    <div class="w-80">{{ activity.activity }}</div>
                                    <div class="w-20 right-text">{{ activity.date|date:'d M Y' }}</div>                                
                                </div>

                            </li>
                        </ul>
                    {% endfor %}
                </div>
            {% endif %}

        </div>
    </div>

    <!-- ACTIONS  -->
    <div class="margin-left-16">
        <div class="actions-card content-card-space flex-this column">
            <h3 class="no-top-margin">Actions</h3>

            {% if request.user.is_authenticated %}
                {% if 'projects/actions/' in request.path %}
                    {% if request.user == project.project_creator %}
                        <a 
                            class="block" 
                            {% if community %}
                                href="{% url 'edit-project' community.id project.unique_id %}"
                            {% endif %}
                            {% if institution %}
                                href="{% url 'inst-edit-project' institution.id project.unique_id %}"
                            {% endif %}
                            {% if researcher %}
                                href="{% url 'researcher-edit-project' researcher.id project.unique_id %}"
                            {% endif %}
                        ><i class="fa-solid fa-pen-to-square"></i> Edit Project</a>
                    {% endif %}
                    {% if request.user == project.project_creator or member_role == 'admin' or member_role == 'editor' or researcher %}
                        {% if not project.source_project_uuid %}
                            <a 
                                class="block" 
                                {% if community %}
                                    href="{% url 'create-project' community.id project.unique_id %}"
                                {% endif %}
                                {% if institution %}
                                    href="{% url 'inst-create-project' institution.id project.unique_id %}"
                                {% endif %}
                                {% if researcher %}
                                    href="{% url 'researcher-create-project' researcher.id project.unique_id %}"
                                {% endif %}

                            ><i class="fa-regular fa-diagram-subtask"></i> Create Sub Project</a>
                        {% else %}
                            <a class="block a-disabled">
                                <i class="fa-regular fa-diagram-subtask"></i> Create Sub Project
                                <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                                    <span class="tooltiptext">
                                        The Project you are viewing is already a sub-project.
                                    </span>
                                </div> 
                            </a>
                        {% endif %}

                    {% endif %}
                {% endif %}

                {% if community %}
                    {% if member_role == 'admin' or member_role == 'editor' %}

                        {% if community.is_approved %}
                            {% if is_community_notified or creator.community == community %}
                                <a class="block" href="{% url 'apply-labels' community.id project.unique_id %}"> <i class="fa-solid fa-tag"></i> Apply Labels</a>
                            {% else %}
                                <a class="block a-disabled"> 
                                    <i class="fa-solid fa-tag"></i> Apply Labels
                                    <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                                        <span class="tooltiptext">
                                            Your community was added as a contributor to this Project. The Project creator needs to notify your community if you wish to apply Labels. Please contact us with any questions.
                                        </span>
                                    </div> 
                                </a>
                            {% endif %}
                        {% else %}
                            <a class="block a-disabled"> 
                                <i class="fa-solid fa-tag"></i> Apply Labels
                                <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                                    <span class="tooltiptext">
                                        Your account needs to be confirmed before you can apply Labels. Please contact us if you have questions.
                                    </span>
                                </div> 
                            </a>
                        {% endif %}

                    {% endif %}
                {% endif %}

                {% if institution %}
                    {% if institution.is_approved %}
                        {% if member_role == 'admin' or member_role == 'editor' %}
                            <a 
                                class="block pointer" 
                                onclick="openModal('notifyCommunitiesModal', 'closeNotifyModal')"
                            ><i class="fa-solid fa-user-group"></i> Notify Communities</a>
                        {% endif %}
                    {% else %}
                        <a class="block a-disabled"> 
                            <i class="fa-solid fa-user-group"></i> Notify Communities
                            <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                                <span class="tooltiptext">
                                    Your account needs to be confirmed before you can notify communities. Please contact us if you have questions.
                                </span>
                            </div> 
                        </a>
                    {% endif %}
                {% endif %}

                {% if researcher %}
                    <a 
                        class="block pointer" 
                        onclick="openModal('notifyCommunitiesModal', 'closeNotifyModal')"
                    ><i class="fa-solid fa-user-group"></i> Notify Communities</a>
                {% endif %}

            {% endif %}
            {% if not project.project_privacy == 'Private' %}
                <div class="border-bottom-grey margin-top-8 margin-bottom-8"></div>
                
                <a id="shareBtn" class="block pointer" onclick="openModal('shareProjectModal', 'closeShareProjectModal')"><i class="fa-solid fa-share-nodes"></i> Share</a>

                <div id="shareProjectModal" class="modal hide">
                    <div class="modal-defaults share-project-modal flex-this column w-100">

                        <div class="flex-this space-between">
                            <div class="w-80">
                                <h2 class="primary-black-text no-top-margin">Share Project</h2>  
                            </div>
                            <div>
                                <div id="closeShareProjectModal" class="pointer"><i class="fa-regular fa-xmark fa-xl"></i></div>
                            </div>
                        </div>

                        <div class="w-100 flex-this column">
                            <div class="w-100 flex-this column margin-bottom-16">
                                <label class="bold margin-top-8 margin-bottom-8 block">Local Contexts Project ID</label>
                                <div class="text-input-to-copy">
                                    <input class="w-100 grey-chip" type="text" value="{{ project.unique_id }}" id="projectUUIDToCopy" readonly>
                                    <button class="copy-btn btn-in-input" data-target="projectUUIDToCopy">Copy ID</button>
                                </div>
    
                                <label class="bold margin-top-8 margin-bottom-8 block">Local Contexts Project URL</label>
    
                                <div class="text-input-to-copy">
                                    <input class="w-100 grey-chip" type="text" value="{{ project.project_page}}" id="projectPageUrlToCopy" readonly>
                                    <button class="copy-btn btn-in-input" data-target="projectPageUrlToCopy">Copy URL</button>
                                </div>

                                <label class="bold margin-top-8 no-bottom-margin block">Embed Project</label>
                                <p class="font-size-14 no-top-margin margin-bottom-8">Add this project's identifiers to your website by copying the code below.</p>
    
                                <div class="text-input-to-copy">
                                    <input class="w-100 grey-chip" type="text" data-project-id="{{ project.unique_id}}" id="projectPageEmbedToCopy" readonly>
                                    <button class="copy-btn btn-in-input" data-target="projectPageEmbedToCopy">Copy Code</button>
                                </div>
                                <p class="font-size-14 margin-top-1 no-bottom-margin">Embed Options</p>
                                <div class="flex-this">
                                    <select id="embedLayoutOptions" name="layout" class="project-sort w-30 margin-top-1 margin-right-1">
                                        <option class="darkteal-text pointer" value="1" selected>Icons Only</option>
                                        <option class="darkteal-text pointer" value="2">Icon and Title</option>
                                        <option class="darkteal-text pointer" value="3">Icon, Title and Text</option>
                                    </select>
                                    <select id="embedLanguageOptions" name="language" class="project-sort w-30 margin-top-1 margin-right-1">
                                        {% if notices %}
                                            <option class="darkteal-text pointer" value="en" selected>English</option>
                                            {% for notice in notices %}
                                                {% for translation in notice.notice_translations.all %}
                                                    <option class="darkteal-text pointer" value="{{ translation.language_tag }}">{{ translation.language }}</option>
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                        {% if project.has_bclabels or project.has_tklabels %}
                                            {% for community, labels in label_groups.items %}
                                                {% for tklabel in labels.tk_labels %}
                                                    <option class="darkteal-text pointer" value="{{ tklabel.language_tag }}">{{ tklabel.language }}</option>
                                                    {% for translation in tklabel.tklabel_translation.all %}
                                                        <option class="darkteal-text pointer" value="{{ translation.language_tag }}">{{ translation.language }}</option>
                                                    {% endfor %}
                                                {% endfor %}
                                                {% for bclabel in labels.bc_labels %}
                                                    <option class="darkteal-text pointer" value="{{ bclabel.language_tag }}">{{ bclabel.language }}</option>
                                                    {% for translation in bclabel.bclabel_translation.all %}
                                                        <option class="darkteal-text pointer" value="{{ translation.language_tag }}">{{ translation.language }}</option>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="border-bottom-grey margin-top-8 margin-bottom-8"></div>
                            <div class="flex-this bold">Share on Social Media</div>
                            <div class="share-to-socials-container">
                                <div class="shareToSocialsBtn" data-social="email" data-project-title="{{ project.title }}" data-project-url="{{ project.project_page }}">
                                    <i class="socials-btn fa-solid fa-envelope" title="Share via Email"></i>
                                </div>
                                <div class="shareToSocialsBtn" data-social="whatsapp" data-project-title="{{ project.title }}" data-project-url="{{ project.project_page }}">
                                    <i class="socials-btn fa-brands fa-whatsapp" title="Share via WhatsApp"></i>
                                </div>
                                <div class="shareToSocialsBtn" data-social="facebook" data-project-title="{{ project.title }}" data-project-url="{{ project.project_page }}">
                                    <i class="socials-btn fa-brands fa-facebook-f" title="Share on Facebook"></i>
                                </div>
                                <div class="shareToSocialsBtn" data-social="twitter" data-project-title="{{ project.title }}" data-project-url="{{ project.project_page }}">
                                    <i class="socials-btn fa-brands fa-twitter" title="Share on Twitter"></i>
                                </div>
                                <div class="shareToSocialsBtn" data-social="linkedin" data-project-title="{{ project.title }}" data-project-url="{{ project.project_page }}">
                                    <i class="socials-btn fa-brands fa-linkedin" title="Share on LinkedIn"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if can_download %}
                    <a class="block" href="{% url 'download-project-zip' project.unique_id %}"><i class="fa-solid fa-download"></i> Download</a>
                {% else %}
                    <a class="block a-disabled"> 
                        <i class="fa-solid fa-download"></i> Download
                        <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                            <span class="tooltiptext">
                                {% if 'anth-ja77-lc-dev-42d5' in request.get_host %}
                                    Project cannot be downloaded on the sandbox site.
                                {% else %}
                                    The account that created this Project needs to be confirmed before download is available.
                                {% endif %}
                            </span>
                        </div> 
                    </a>
                {% endif %}

            {% else %}
                <a class="block a-disabled"> 
                    <i class="fa-solid fa-share-nodes"></i> Share
                    <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                        <span class="tooltiptext">
                            Private Projects cannot be shared.
                        </span>
                    </div> 
                </a>
                <a class="block a-disabled"> 
                    <i class="fa-solid fa-download"></i> Download
                    <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                        <span class="tooltiptext">
                            Private Projects cannot be downloaded.
                        </span>
                    </div> 
                </a>
            {% endif %}

            {% if 'projects/actions/' in request.path %}

                {% if request.user.is_authenticated and request.user == project.project_creator %}
                    <div class="border-bottom-grey margin-top-8 margin-bottom-8"></div>

                    <a 
                        class="block" 
                        {% if community %}
                            href="{% url 'community-archive-project' community.id project.unique_id %}"
                        {% endif %}
                        {% if institution %}
                            href="{% url 'institution-archive-project' institution.id project.unique_id %}"
                        {% endif %}
                        {% if researcher %}
                            href="{% url 'researcher-archive-project' researcher.id project.unique_id %}"
                        {% endif %}
                    ><i class="fa-solid fa-box-archive"></i> {% if project_archived %} Unarchive {% else %} Archive {% endif %}

                        <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                            <span class="tooltiptext">
                                Projects that are archived will only appear in your archived project list. Projects can be unarchived at any time.
                            </span>
                        </div> 

                    </a>

                    {% if not project.has_labels %}
                        <a 
                            class="block pointer" 
                            onclick="openModal('deleteProjectModal', 'closeProjectDeletionModal')"
                        ><i class="fa-solid fa-trash"></i> Delete

                        <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                            <span class="tooltiptext">
                                Permanently remove this project. Projects with Labels cannot be deleted.
                            </span>
                        </div> 
                    
                        </a>

                        <div id="deleteProjectModal" class="modal hide">
                            <div class="modal-defaults deactivate-modal flex-this column w-100">
                                <div class="w-100">
                    
                                    <div>
                                        <h2 class="primary-black-text no-top-margin">Are you sure?</h2>  
                                        <p>Are you sure you want to delete your Project? <br>
                                            This will delete the Project for everyone and cannot be undone. <br><br>
                                            <small>You will be redirected to the Projects page.</small> <br>
                                        </p>  
                                    </div>
                                    <div class="flex-this w-100 text-align-center">
                                        <form id="deleteProjectForm" method="POST">
                                            {% csrf_token %}
                                            <button id="continueProjectDeletionBtn" class="primary-btn white-btn w-100" name="delete_project">Yes, delete this Project</button>    
                                        </form>
                                        <div id="closeProjectDeletionModal" class="primary-btn action-btn margin-left-8">Cancel</div>
                                    </div>
                    
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <a class="block a-disabled"> 
                            <i class="fa-solid fa-trash"></i> Delete
                            <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                                <span class="tooltiptext">
                                    Projects with Labels cannot be deleted.
                                </span>
                            </div> 
                        </a>
                    {% endif %}
                {% endif %}

            {% endif %}

        </div>  

        <!-- View As card: in view-projects: If user is logged in AND belongs to account of a contributor of Project, display affiliations -->
        {% if not project.project_privacy == 'Private' %}
            {% if not '/actions/' in request.path %}
                {% if communities or institutions or user_researcher %}
                    <div class="actions-card content-card-space flex-this column">
                        <h3 class="no-top-margin">View As 
                            <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                                <span class="tooltiptext">
                                    You are viewing what this Project looks like publicly. To access the action page as a contributor on this Project, select an account below.
                                </span>
                            </div> 
                        </h3>

                        {% for community in communities %}
                            <a class="block" href="{% url 'community-project-actions' community.id project.unique_id %}"> 
                                <i class="fa-solid fa-address-card"></i> {{ community.community_name }}
                            </a>
                        {% endfor %}
                        {% for institution in institutions %}
                            <a class="block" href="{% url 'institution-project-actions' institution.id project.unique_id %}"> 
                                <i class="fa-solid fa-address-card"></i> {{ institution.institution_name }}
                            </a>
                        {% endfor %}
                        {% if user_researcher %}
                            <a class="block" href="{% url 'researcher-project-actions' user_researcher.id project.unique_id %}"> 
                                <i class="fa-solid fa-address-card"></i> {{ user_researcher.user }} (Researcher)
                            </a>
                        {% endif %}
                    </div> 
                {% endif %}
            {% else %}
                <div class="actions-card content-card-space flex-this column">
                    <h3 class="no-top-margin">View As 
                        <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                            <span class="tooltiptext">
                                You are viewing the action page of this Project, which is only accessible to contributors. Use this button to see what this Project looks like publicly.
                            </span>
                        </div> 
                    </h3>
                    <a 
                        class="block" 
                        href="{% url 'view-project' project.unique_id %}"
                    ><i class="fa-solid fa-eye"></i> Public View</a>
                </div> 
            {% endif %}
        {% endif %}

        <!-- Community: set project status -->
        {% if community %}
            {% include 'projects/project-status.html' %}
        {% endif %}

        <!-- List of communities notified -->
        {% if community or researcher or institution %}
            <div class="actions-card-notifified content-card-space flex-this column">
                <div class="flex-this">
                    <h3 class="no-top-margin no-bottom-margin">Communities Notified</h3>
                    <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                        <span class="tooltiptext">
                            <i class="bold">Seen</i><br> The community has acknowledged the Project but has not made a decision about applying Labels.<br>
                            <i class="bold">No Labels Pending</i><br> The community will not apply Labels to the Project.<br>
                            <i class="bold">Labels Pending</i><br> The community is deciding which Label(s) to apply to the Project.<br>
                            <i class="bold">Labels Applied</i><br> The community has applied Labels to the Project.
                        </span>
                    </div>                     
                </div>

                <div class="border-bottom-grey">
                    <p>
                        Listed below are the communities that have been notified about this Project 
                        including the status of their decision about the Project.
                    </p>
                </div>
                {% if statuses %}
                    {% for status in statuses %}
                        <div class="border-bottom-grey">
                            <div><p><span class="bold"><a href="{% url 'public-community' status.community.id %}" class="darkteal-text underline-hover">{{ status.community }}</a> </span></p></div>
                            <div>
                                <p><em> Project status: </em>
                                    {% if status.seen and status.status == None %} Seen
                                    {% elif status.seen and status.status == 'pending' %} Labels Pending
                                    {% elif status.seen and status.status == 'not_pending' %} No Labels Pending
                                    {% elif status.seen and status.status == 'labels_applied' %} Labels Applied
                                    {% else %} Sent {% endif %}
                                </p>
                            </div>    
                        </div>
                    {% endfor %}
                {% else %}
                    <p><em>No communities notified yet</em></p>
                {% endif %}
            </div>
        {% endif %}
    </div>

</div>

{% if institution.is_approved or researcher %}
    <div id="notifyCommunitiesModal" class="modal hide">

        <div class="modal-defaults notice-modal flex-this column w-100">
            <div class="w-100">
                <form method="POST" autocomplete="off">
                    {% csrf_token %}

                    <div class="flex-this space-between">
                        <div><h2 class="primary-black-text no-top-margin">Notify Communities</h2></div>
                        <div>
                            <div id="closeNotifyModal" class="close-modal-btn pointer"><i class="fa-regular fa-xmark fa-xl"></i></div>
                        </div>            
                    </div>

                    <div>
                        <p>
                            Notify relevant communities about this Project to add them as a potential contributor. 
                            Notified communities can decide if they would like to add their Labels to the Project. 
                            Notified communities will also be able to see and edit Project details, see and add Project comments, and see Project activity.
                        </p>  
                    </div>

                    {% if communities %}
                        <label>Select community/communities to notify about this Project</label><br>
            
                        <div class="w-100">
                            <select id="communities-select" class="w-100" onchange="selectCommunities()">
                                <option>Select a Community</option>
                                {% for community in communities %}
                                    <option id="{{ community.id }}">{{ community.community_name }}</option>
                                {% endfor %}
                            </select>                    
                        </div>
            
                        <div class="flex-this margin-top-16 wrap">
                            {% for community in communities %}
                                <div id="selected-community-{{ community.id }}" class="hide margin-top-8">
                                    <div class="grey-chip flex-this row space-between">
                                        <div><p class="center-name">{{community.community_name}}</p></div>
                                        <div id="close-{{ community.id }}" class="close-x pointer" onclick="cancelCommunitySelection(this)"><div>&times;</div></div>
                                    </div>
                                </div>
                                <div id="comm-id-input-{{ community.id }}" style="display: none;"></div>
                            {% endfor %}
                        </div>
                        
                        <div class="flex-this flex-end w-100 margin-top-8">
                            <button class="primary-btn action-btn" name="notify_btn">Send Notification <i class="fa fa-users" aria-hidden="true"></i></button>    
                        </div>

                    {% else %}
                        <small class="bold">No communities are currently available to be notified</small>
                    {% endif %}
                </form>
            </div>
        </div>

    </div>
{% endif %}

{% if member_role == "admin" or member_role == "editor" or request.user == project.project_creator or researcher %}
    <div id="linkProjectsModal" class="modal hide">

        <div class="modal-defaults notice-modal flex-this column w-100">
            <div class="w-100">
                <form method="POST" autocomplete="off">
                    {% csrf_token %}

                    <div class="flex-this space-between">
                        <div><h2 class="primary-black-text no-top-margin">Connect Existing Projects</h2></div>
                        <div>
                            <div id="closeLinkProjectsModal" class="pointer"><i class="fa-regular fa-xmark fa-xl"></i></div>
                        </div>            
                    </div>

                    <div>
                        <p>
                            Connecting related Projects enables better access to other Projects that have similar data.
                        </p>  
                    </div>

                    <div id="relatedProjectsList" class="dropdown-check-list" tabindex="100">
                        <span class="anchor">Select from the list below...</span>
                        <ul>
                            {% for p in projects_to_link %}
                                <li><input name="projects_to_link" value="{{p.0}}" type="checkbox" /><span>{{p.1}}</span></li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="margin-top-16 flex-this flex-end">
                        <button id="connectProjectsBtn" class="primary-btn disabled-btn" name="link_projects_btn" disabled>Connect Projects</button>
                    </div>

                </form>
            </div>
        </div>

    </div>
{% endif %}