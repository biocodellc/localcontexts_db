{% load static %}{% load custom_researcher_tags %}
{% researcher_notifications researcher as notifications %}
{% unread_notifications researcher as unread_exist %}

    <div class="dashcard auto-margin">
        
        <!-- Top Nav -->
        <div class="flex-this w-100 space-between">
            <div class="loc">
                <a href="{% url 'dashboard' %}" class="darkteal-text underline-hover"> {{ request.user.get_full_name }}</a> 
                >> {{ researcher.user.get_full_name }}
            </div>

            {% if user_can_view %}
                <!-- Notifications -->
                <div class="flex-this w-30 flex-end">
                    <div class="dropdown">
                        <a onclick="toggleNotifications()" class="primary-btn white-btn dropbtn"> 
                            Notifications 
                            <i 
                            class="fa {% if unread_exist %} fa-bell orange-text {% else %} fa-bell-o {% endif %}" 
                            aria-hidden="true"
                            ></i>
                        </a>
                        <div id="notification-v2" class="notification-dropdown-content">
                        <div class="border-bottom-solid-teal center-text">
                            <span class="orange-text">{{ researcher.user.get_full_name }} Notifications</span>
                        </div>

                            {% if notifications %}
                                {% for n in notifications %}

                                    <div class="border-bottom-solid-teal">
                                        {% if n.notification_type == 'Labels' or n.notification_type == 'Projects' %}
                                            {% if n.reference_id %}
                                                <a href="{% anchor 'researcher-projects' n.reference_id researcher.id %}" id="{{ researcher.id }}_{{ n.id }}" onclick="markAsReadResearcher(this); return true;">
                                            {% else %}
                                                <a href="{% url 'researcher-projects' researcher.id %}" id="{{ researcher.id }}_{{ n.id }}" onclick="markAsReadResearcher(this); return true;">
                                            {% endif %}
                                        {% endif %}
                                        {% if n.notification_type == 'Connections' %}
                                            <a href="#" id="{{ researcher.id }}_{{ n.id }}" onclick="markAsReadResearcher(this); return true;">
                                        {% endif %}
                                            <div class="flex-this space-between margin-top-1">
                                                <div>
                                                    <span id="notification-label-tag-{{ n.id }}" 
                                                        class="notification-type-tag white-text font-size-12 {% if n.viewed %} grey {% else %} orange-bg {% endif %}"
                                                    >
                                                    {% if n.notification_type == 'Notices' %} Notices {% endif %}
                                                    {% if n.notification_type == 'Labels' %} Labels {% endif %}
                                                    {% if n.notification_type == 'Activity' %} Activity {% endif %}
                                                    {% if n.notification_type == 'Projects' %} Projects {% endif %}
                                                    {% if n.notification_type == 'Connections' %} Connections {% endif %}
                                                </span></div>
                                                <div><span class="font-size-12 grey-text">{{ n.created }}</span></div>
                                            </div>
                                            <div><p class="darkteal-text font-size-14"> {{ n.title }}</p></div>    
                                        </a>
                                    </div>

                                {% endfor %}
                            {% endif %}

                        </div>
                    </div>

                    {% if user_can_view %}
                        <div class="margin-left-8"><a href="{% url 'researcher-update' researcher.id %}" class="darkteal-text primary-btn white-btn"><i class="fa fa-cog" aria-hidden="true"></i> Settings</a></div>
                    {% endif %}
                </div>
            {% endif %}
            
        </div>
            <!-- Image, headers, description -->
        <div class="flex-this">
            <div class="researcher-img-container">
                <img 
                    src=" {% if researcher.image %} {{ researcher.image.url }} {% else %} {% static 'images/placeholders/researcher-place.jpg' %} {% endif %}" 
                    alt="{{ researcher.researcher_name }} image"
                >
            </div>

            <div class="flex-this column dashcard-text-container">
                    <div>
                        <h3 class="dashcard-h3 darkteal-text">{% if researcher.user.get_full_name %} {{ researcher.user.get_full_name }} {% else %} {{ researcher.user.username }} {% endif %}</h3>
                    </div>
                    <div>
                        <p class="dashcard-subheader">Researcher | {% if researcher.primary_institution %}{{ researcher.primary_institution }}{% endif %}<br>
                            Location: {% if researcher.user.profile.city_town %} {{ researcher.user.profile.city_town }}, {% endif %} {% if researcher.user.profile.state_province_region %} {{ researcher.user.profile.state_province_region }}, {% endif %} {% if researcher.user.profile.country.name %} {{ researcher.user.profile.country.name }}{% endif %}
                            {% if not researcher.user.profile.city_town and not researcher.user.profile.state_province_region and not researcher.user.profile.country %} None specified {% endif %}
                        </p>
                    </div>

                    <!-- ORCID display based on how it sits in the db -->
                    {% if researcher.orcid %}
                        {% if 'https://sandbox.orcid.org/' in researcher.orcid %}
                            <div itemscope itemtype="https://schema.org/Person"><a class="darkteal-text underline-hover" itemprop="sameAs" content="{{ researcher.orcid }}" href="{{ researcher.orcid }}" target="orcid.widget" rel="me noopener noreferrer" style="vertical-align:top;">
                                <img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="width:1em;margin-right:.5em;" alt="ORCID iD icon">{{ researcher.orcid }}</a>
                            </div>
                        {% elif 'https://orcid.org/' in researcher.orcid %}
                            <div itemscope itemtype="https://schema.org/Person"><a class="darkteal-text underline-hover" itemprop="sameAs" content="{{ researcher.orcid }}" href="{{ researcher.orcid }}" target="orcid.widget" rel="me noopener noreferrer" style="vertical-align:top;">
                                <img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="width:1em;margin-right:.5em;" alt="ORCID iD icon">{{ researcher.orcid }}</a>
                            </div>
                        {% elif 'X' in researcher.orcid %}
                            <div itemscope itemtype="https://schema.org/Person"><a class="darkteal-text underline-hover" itemprop="sameAs" content="https://sandbox.orcid.org/{{ researcher.orcid }}" href="https://sandbox.orcid.org/{{ researcher.orcid }}" target="orcid.widget" rel="me noopener noreferrer" style="vertical-align:top;">
                                <img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="width:1em;margin-right:.5em;" alt="ORCID iD icon">https://sandbox.orcid.org/{{ researcher.orcid }}</a>
                            </div>
                        {% else %}
                            <div itemscope itemtype="https://schema.org/Person"><a class="darkteal-text underline-hover" itemprop="sameAs" content="https://orcid.org/{{ researcher.orcid }}" href="https://orcid.org/{{ researcher.orcid }}" target="orcid.widget" rel="me noopener noreferrer" style="vertical-align:top;">
                                <img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="width:1em;margin-right:.5em;" alt="ORCID iD icon">https://orcid.org/{{ researcher.orcid }}</a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div>
                            <img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="width:1em;margin-right:.5em;" alt="ORCID iD icon"> <small>No ORCiD specified</small>
                        </div>
                    {% endif %}

                    <div>
                        <p class="dashcard-description description-sm">{% if researcher.description %}{{ researcher.description }} {% else %} No description provided. {% endif %}</p>
                    </div>

            </div>

            <!-- Count cards -->
            <div class="flex-this column stats-card-container">

                <!-- Count of Labels applied to researcher projects -->
                {% get_labels_count researcher as total_labels %}
                <div class="stats-card flex-this space-between">
                    <div><p>{% if total_labels < 10 %} 0{{ total_labels }} {% else %} {{ total_labels }} {% endif %}</p></div>
                    <div><span>Labels</span></div>
                </div>

                <!-- Count of notices placed by researcher -->
                {% get_notices_count researcher as total_notices %}
                <div class="stats-card flex-this space-between">
                    <div><p>{% if total_notices < 10 %} 0{{ total_notices }} {% else %} {{ total_notices }} {% endif %}</p></div>
                    <div><span>Notices</span></div>
                </div>
    
                <div class="stats-card flex-this space-between">
                    <div>
                        <p>
                            {% connections_count researcher as connect_count %}
                            {% if connect_count < 10 %}0{{ connect_count }}{% else %}{{ connect_count }}{% endif %}
                        </p>
                    </div>
                    <div>
                        <span>Connections</span>
                    </div>
                </div>
            </div>

        </div>

    </div>
